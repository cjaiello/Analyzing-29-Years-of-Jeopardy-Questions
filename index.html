<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script src="build/d3.layout.cloud.js" charset="utf-8"></script>

<style>
  /* Title of Page */
  h1 {
    font-size: 20px;
    font-family: "Century Gothic",CenturyGothic,AppleGothic,sans-serif;
    text-align: center;
    line-height: 15px;
    margin-bottom: 0px;
    color: #399DB1;
  }
  h2 {
    font-size: 15px;
    font-family: "Century Gothic",CenturyGothic,AppleGothic,sans-serif;
    text-align: center;
    line-height: 17px;
    color: #399DB1;
  }
  /* Body text on page */
  body {
    background-color: #EBFAFF;
    font-size: 12px;
    font-family: "Century Gothic",CenturyGothic,AppleGothic,sans-serif;
  }

  #wrapper {
    overflow: hidden;
  }

  #locationOfSVGs{
    float:left;
  }

  .calendarBox {
    width: 650px;
    height: 650px;
    float: left;
  }
  /* All labels on charts */
  .labels {
    font-size: 11px;
    font-family: Calibri,sans-serif;
  }

  .td-center {
    text-align: center;
  }

  .td-leftpadding {
    padding-left: 50px;
  }

  .td-rightpadding {
    padding-right 50px;
  }

  #locationOfSVGs{
    padding-bottom: 50px;
  }

  .bar text.value {
    fill: #000000;
  }

  .axis {
    shape-rendering: crispEdges;
  }

  .axis path {
    fill: none;
  }

  .x.axis line {
    stroke: #000;
    stroke-opacity: 0.2;
  }

  .y.axis path {
    stroke: black;
  }

  /* Styling below used for Calendar view */
  #chart{
    width: 800px;
    margin: 0 auto;
  }
  .background {
    fill: #eee;
  }

  line {
    stroke: #fff;
  }

  text.active {
    fill: red;
  }

  .day {
    fill: #fff;
    stroke: #ccc;
  }

  .month {
    fill: none;
    stroke: #fff;
    stroke-width: 4px;
  }
  .year-title {
    font-size: 1.5em;
  }

  /* color ranges */
  .RdYlGn .q0-11{fill:rgb(139, 205, 217)}
  .RdYlGn .q1-11{fill:rgb(101, 189, 205)}
  .RdYlGn .q2-11{fill:rgb(62, 172, 192)}
  .RdYlGn .q3-11{fill:rgb(55, 155, 173)}
  .RdYlGn .q4-11{fill:rgb(49, 139, 155)}
  .RdYlGn .q5-11{fill:rgb(43, 121, 135)}
  .RdYlGn .q6-11{fill:rgb(37, 103, 115)}
  .RdYlGn .q7-11{fill:rgb(31, 85, 95)}
  .RdYlGn .q8-11{fill:rgb(25, 69, 77)}
  .RdYlGn .q9-11{fill:rgb(19, 51, 57)}
  .RdYlGn .q10-11{fill:rgb(9, 25, 29)}

  /* hover info */
  #tooltip {
    background-color: #fff;
    border: 2px solid #ccc;
    padding: 10px;
  }

</style>

<body>
  <center>
    <h1>29 Years of Jeopardy Questions!</h1>
  </center>
  <div id="wrapper">
    <div id="locationOfSVGs">
    </div>
    <div class="calendarBox">
    </div>
  </div>
  <center>
    <table>
      <tr>
        <td>
          <div id="locationOfWordCloud" align="center">
          </div>
        </td>
      </tr>
      <tr>
        <td>
          <div id="locationOfWordCloudLabel" align="center">
          </div>
        </td>
      </tr>
    </table>
  </center>
</body> 

<script>

  d3.csv('data/jeopardy_questions_and_answers_preprocessed_groupingvalues.csv', function(err, data) {
    if(err) console.log(err);

    // Aggregate data set
    data = aggregateByRound(data);

    //buildBarVis(data, 85, 1, "Round");
    buildBarVis(data, 85, 1, "Round");
  });

  /*
  * Helper for aggregating data
  * @data: The data from the csv to aggregate
  */
  function aggregateByRound(data){

    var arrayOfJeopardyQuestions = d3.nest()
    arrayOfJeopardyQuestions = d3.nest()
    .key(function(data) { 
      return data.Round; 
    })
    .entries(data);

    return arrayOfJeopardyQuestions;
  }

  /*
  * Helper for aggregating data
  * @data: The data from the csv to aggregate
  */
  function aggregateByYear(data){

    var arrayOfJeopardyQuestions = d3.nest()
    arrayOfJeopardyQuestions = d3.nest()
    .key(function(data) { 
      return data.Year; 
    })
    .entries(data);

    return arrayOfJeopardyQuestions;
  }

  /*
  * Helper for aggregating data
  * @data: The data from the csv to aggregate
  */
  function aggregateByValue(data){

    var arrayOfJeopardyQuestions = d3.nest()
    arrayOfJeopardyQuestions = d3.nest()
    .key(function(data) { 
      return data.Value; 
    })
    .entries(data);

    return arrayOfJeopardyQuestions;
  }

  // Tells the name of the viz based on its number.
  // @vizNumber: the number of the visualization,
  // which is either 1, 2, or 3
  function getVizName(vizNumber){
    vizNumber = parseInt(vizNumber);
    if(vizNumber == 1){
      return "firstChart";
    } else if(vizNumber == 2){
      return "secondChart";
    } else if(vizNumber == 3){
      return "thirdChart";
    } else return "fourthChart";
  }

  // Creates a bar visualization
  // @data: the data from the csv
  // @translateXCoordinate: How far over (x-wise) the graph should go
  // @vizNumber: The number of the viz, either 1 2 or 3
  // @vizLabel: The label for the viz (what attribute it is)
  function buildBarVis(data, translateXCoordinate, vizNumber, vizLabel) {

    var w = 330;
    var h = 700;

    var format = d3.format(",.0f");

    var x = d3.scale.linear().range([10, w-50]),
        y = d3.scale.ordinal().rangeBands([0, h-50], .1);

    var xAxis = d3.svg.axis().scale(x).orient("top").ticks(4).tickSize(-h + 60),
        yAxis = d3.svg.axis().scale(y).orient("left").tickSize(0);

    var svg = d3.select("#locationOfSVGs").append("svg")
        .attr("class", getVizName(vizNumber))
        .attr("padding-left", "20")
        .attr("margin-left", "20")
        .attr("width", w+125)
        .attr("height", h)
      .append("g")
        .attr("transform", "translate(" + (translateXCoordinate + 25) + "," + 30 + ")");

    // Set the scale domain.
    x.domain([0, d3.max(data, function(d) {
      return d.values.length; 
    })]);
    y.domain(data.map(function(d) { return d.key; }));

    // Adding x axis to screen
    svg.append("g")
        .attr("class", "x axis")
        .call(xAxis);

    // Adding y axis to screen
    svg.append("g")
        .attr("class", "labels")
        .attr("transform", "translate(" + 10 + ",0)")
        .call(yAxis);

    var bar = svg.selectAll("g.bar")
        .data(data)
      .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) {
          return "translate(1," + y(d.key) + ")"; 
        });

    // Putting the rectangles on the bar chart
    bar.append("rect")
        .attr("fill", "#399DB1")
        .attr("transform", "translate(" + 10 + ",0)")
        .attr("width", function(d, i) {
          return x(d.values.length); 
        })
        .attr("height", y.rangeBand())
        .on("mouseover", function(d, i) {
          if(vizNumber == 1){
          // First, remove the old second and third charts
          d3.select("svg.secondChart")
          .remove();
          d3.select("svg.thirdChart")
            .remove();
            buildBarVis(aggregateByValue(data[i].values), 25, vizNumber + 1, "Value");
          } else if (vizNumber == 2) {
            d3.select(".calendarLabel")
              .remove();
            d3.select(".calendarBoxSVG")
              .remove();
            buildCalendarViewVis(aggregateByYear(data[i].values), 25, vizNumber + 1, "Air Date");
          }
          d3.select(this)
            .attr("fill", "#8dcad6");
         })
        .on("mouseout", function() {
          d3.select(this)
            .attr("fill", "#399DB1");
      });

    // Placing the label text for each bar
    bar.append("text")
        .attr("class", "labels")
        .attr("x", function(d) { 
          return x(d.values.length); 
        })
        .attr("y", y.rangeBand() / 2)
        .attr("dx", 20)
        .attr("dy", ".35em")
        .style("font-weight","bold")
        .attr("text-anchor", "end")
        .text(function(d) {
          return format(d.values.length); 
        });

    svg.append("text")
        .attr("x", w / 2 - 50 )
        .attr("y", h - 30)
        .style("font-size","15px")
        .style("font-weight","bold")
        .attr("fill", "black")
        .text(vizLabel);

  }

  // This function will find matches for a specific word in a given
  // array of input.
  // @input: An array of strings
  // @ wordToFind: The word you want to find in the given input
  function findMatches(input, wordToFind){
    var numberOfMatches = 0; 
    // Go through all questions in this piece of data:
    for(var counter = 0; counter < input.length; counter++){
      var currentQuestion = input[counter];
      // And find how many matches for a particular word there are:
      var regex = new RegExp("(?:^|\\s)" + wordToFind + "(?=\\s|$)");
      var matches = currentQuestion.match(regex);
      if(matches != null){
        numberOfMatches = numberOfMatches + matches.length;
      }
    }
    return numberOfMatches;
  }

  // Function to build a wordcloud for rows in the data set
  // @data: The data from the csv
  function buildWordCloudVis(data, year){

    var re = new RegExp("^((0?[1-9]|1[012])[- /.](0?[1-9]|[12][0-9]|3[01])[- /.](" + year + "))$"), key;
    var arrayOfDataPointsFromCorrectYear = [];

    // The "data" object has all data from this round -> value, so
    // we need to separate it by year. Find all data points that have
    // a year that matches "year," the year we're currently hovering
    // over in the calendar chart.
    for (key in data){
      // If this key in the object has the correct year
      if (re.test(key)){
        // Add it to our list of objects (data points) from the
        // correct year
        arrayOfDataPointsFromCorrectYear.push(data[key][0])
      }
    }

    // If this year actually has data in it, let them click it:
    if(arrayOfDataPointsFromCorrectYear.length > 0){

      var wordMap = {}; // Key is word, value is number of times seen
      var wordMapList = []; // Just a list of all words (so, all keys)
      var questionList = []; // All questions in this data set

      // These steps populate the above three variables
      for(var counter = 0; counter < arrayOfDataPointsFromCorrectYear.length; counter++){
        // Set 'question' equal to each item's question
        var question = arrayOfDataPointsFromCorrectYear[counter].Question;
        questionList.push(question);
        // Split each string into an array
        var listOfWords = question.split(" ");
        // For each word in the question
        for(var innerCounter = 0; innerCounter < listOfWords.length; innerCounter++){
          var currentWord = listOfWords[innerCounter];
          // Trim away any commas and periods
          currentWord = currentWord.replace(/,$/, "");
          currentWord = currentWord.replace(/\)/, "");
          currentWord = currentWord.replace(/\(/, "");
          currentWord = currentWord.replace(/\""/, "");
          // And make it lowercase:
          currentWord = currentWord.toLowerCase();
          // If it's not an empty word or a period (or what I've deemed a plain word):
          var arrayOfPlainWords = ["\s", "\.", "a", "but", "an", "and", "the", "was", "this", "had", "has", "can", "the", "too", "to", "for", "of", "is", "by", "on", "if", "like", "i", "\&", "it\'s", "from", "or", "with", "at", "as", "that", "these", "be", "it", "are", "in"];
          // If this word isn't in arrayOfPlainWords:
          if(arrayOfPlainWords.indexOf(currentWord) < 0){
            // If we haven't seen this word yet
            if (!(currentWord in wordMap)){
              // Count its matches
              var numberOfMatches = findMatches(questionList, currentWord);
              // Add to our list of words seen:
              wordMapList.push(currentWord);
              // And keep track of its count as well:
              wordMap[currentWord] = numberOfMatches;
            } else {
              // Count its matches
              var numberOfMatches = findMatches(questionList, currentWord);
              // And keep track of its count as well:
              wordMap[currentWord] += numberOfMatches;
            }
          }
        }
      }

      // Colors to choose from for the words
      var color = d3.scale.linear()
              .domain([0,1,2,3,4,5,6,7, 8, 9, 10, 11, 12])
              .range(["#fa2d74", "#1e63e9", "#008547", "#785e94", "#3b0576", "#58011c", "#458b00", "#e93f1e", "#002849", "#16d79c", "#ff8d00", "#0000ff"]);


      // Actually building the word cloud
      d3.layout.cloud().size([1200, 600])
          .words(wordMapList.map(function(d) {
            return {text: d, size: 15 + wordMap[d]/3};
          }))
          .rotate(function() { return (~~(Math.random() * 6) - 3) * 30; })
          .font("Impact")
          .fontSize(function(d) { return d.size; })
          .on("end", draw)
          .start();

        
        function draw(words) {
          d3.select("#locationOfWordCloud").append("svg")
                  .attr("width", 1200)
                  .attr("height", 600)
                  .attr("class", "wordCloud")
                  .append("g")
                  .attr("transform", "translate(600,300)")
                  .selectAll("text")
                  .data(words)
                  .enter().append("text")
                  .style("font-size", function(d) { return d.size + "px"; })
                  .style("fill", function(d, i) { 
                    return color(Math.random() * 12); })
                  .style("font-family", "\"Century Gothic\",CenturyGothic,AppleGothic,sans-serif")
                  .attr("transform", function(d) {
                      return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                  })
                  .text(function(d) { return d.text; });
      } 
      // Lastly, label the word
      d3.select("#locationOfWordCloudLabel").append("text")
          .attr("class", "wordCloudLabel")
          .attr("x", 300)
          .attr("y", 300)
          .style("font-size","25px")
          .style("font-weight","bold")
          .attr("fill", "black")
          .text("Questions from " + arrayOfDataPointsFromCorrectYear[0].Round + " Round in the Year " + year + " With a Value of $" + arrayOfDataPointsFromCorrectYear[0].Value);
    }
  }


  // Function will build a pie visualization for the data
  /*function buildPieVis(data, translateXCoordinate, vizNumber, vizLabel) {
    var color = d3.scale.ordinal()
    .range(["#73a8d8", "#abe7e6" , "#509795", "#67afae", "#73d8d6", "#b2e7d6", "#d8f3ea" , "#8ccfdc", "#53b7ca", "#399db1", "#2c7a89", "#205762", "#8fc1cb", "#5f8187", "#64bfd0"]);

  // Width, height, and radius for pie chart
  var width = 550,
  height = 800,
  radius = Math.min(width, height) / 2;

  var centerPlacement = width / 2;

  // Outer and inner radii
  var outerRadius = 195;
  var innerRadius = 0;    

  // Adding svg element to body, setting its width and height,
  // and moving it to a certain location on the screen
  var vis = d3.select("#locationOfSVGs")
        .append("svg")
        .attr("class", getVizName(vizNumber))
        .data([data])
        .attr("width", width)
        .attr("height", height)
        .append("svg:g") 
        .attr("transform", "translate(" + 300 + "," + 300 + ")");

  // Setting inner and outer radii for each arc piece
  var arc = d3.svg.arc()
  .innerRadius(innerRadius)
  .outerRadius(outerRadius);

  // Selecting a pie chart
  var pie = d3.layout.pie()
        .value(function(d) { return d.values.length; }); // Getting length of values array

  /* Selects all slices in g, associates pie data, 
   * makes g elements for each item in the array,
   * creates groups to hold each slice,
   * and adds the class "slice" to each slice 
   * for styling purposes
   */ /*
   var arcs = vis.selectAll("g.slice") 
   .data(pie)
   .enter()
   .append("svg:g")
   .attr("class", "slice")
   .on("mouseover", function(d, i) {
      if(vizNumber == 1){
      // First, remove the old second and third charts
      d3.select("svg.secondChart")
      .remove();
      d3.select("svg.thirdChart")
        .remove();
        buildPieVis(aggregateByYear(data[i].values), 25, vizNumber + 1, "Year");
      } else if (vizNumber == 2) {
        d3.select("svg.thirdChart")
          .remove();
        buildPieVis(aggregateByValue(data[i].values), 25, vizNumber + 1, "Value");
      }
      d3.select(this)
        .attr("fill", "#399DB1");
     })
    .on("click", function(d, i) {
      if(vizNumber == 3){
        // First remove old word cloud:
        d3.select(".wordCloud").remove();
        // Remove its old label too:
        d3.select(".wordCloudLabel").remove();
        // Now make a new one:
        buildWordCloudVis(data[i], data[i].key);
        d3.select(this)
          .attr("fill", "#6dbd6f");
      }})
    .on("mouseout", function() {
      d3.select(this)
        .attr("fill", "#000000");
      });

      // Setting slice colors and creating SVG path
      arcs.append("svg:path")
      .attr("fill", function(d, i) { 
        return color(i); } )
      .attr("d", arc);

      // Labeling each slice and placing label
      arcs.append("svg:text")
        .attr("class", "labels")
        .attr("transform", function(d, i) {
          var c = arc.centroid(d),
          x = c[0],
          y = c[1],
          // pythagorean theorem for hypotenuse
          h = Math.sqrt(x*x + y*y);
          return "translate(" + (x/h * 200) +  ',' + (y/h * 200) + ")rotate(" + angle(d) + ")"})
        // Centering text on origin
        .style("font-size", "10.5px")
        .attr("text-anchor", function(d) {
          // are we past the center?
          return (d.endAngle + d.startAngle)/2 > Math.PI ? "end" : "start";})
        .text(function(d, i) { 
          console.log(getVizName(vizNumber));
          return data[i].key + ": " + data[i].values.length; 
        });

      var polyline = svg.select(".lines").selectAll("polyline")
        .data(pie(data), key);
      
      polyline.enter()
        .append("polyline");

      polyline.transition().duration(1000)
        .attrTween("points", function(d){
          this._current = this._current || d;
          var interpolate = d3.interpolate(this._current, d);
          this._current = interpolate(0);
          return function(t) {
            var d2 = interpolate(t);
            var pos = outerArc.centroid(d2);
            pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1);
            return [arc.centroid(d2), outerArc.centroid(d2), pos];
          };      
        });
      
      polyline.exit()
        .remove();

      // Labeling each pie chart
      d3.select("." + getVizName(vizNumber)).append("text")
          .attr("x", 175 )
          .attr("y", 550)
          .attr("class", "pieLabel")
          .style("font-size","15px")
          .style("font-weight","bold")
          .attr("fill", "black")
          .text(vizLabel);
      }

  // Computes the angle of an arc, converting from radians to degrees.
  // Source: http://bl.ocks.org/Guerino1/2295263
  // User Guerino1, posted on April 3, 2012
  function angle(d) {
    var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
    return a > 90 ? a - 180 : a;
  }*/

  function buildCalendarViewVis(data, translateXCoordinate, vizNumber, vizLabel){
    var width = 325,
    height = 45,
    cellSize = 5;

    var percent = d3.format(".1%"),
        format = d3.time.format("%m/%d/%Y");
        /* Note to preserve one's sanity later:
         * d3 expects dates in mm/dd/yyyy format according
         * to what's written above. If you have m/dd/yyyy
         * (so, for example, 8/23/2007), that piece of
         * data won't work in the d3 calendar view.
         * It specifically needs to be 08/23/2007, with two
         * digits for the month. */

    var color = d3.scale.quantize()
        .domain([1, 10])
        .range(d3.range(11).map(function(d) {
          return "q" + d + "-11"; }));

    d3.select(".calendarBox").append("div").attr("width", 300).style("padding-top", "10px").attr("height", 900).attr("class", "calendarBoxSVG");

    var svg = d3.select(".calendarBoxSVG").selectAll("svg")
        .data(d3.range(1984, 2013))
      .enter().append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("class", "RdYlGn")
        .on("click", function(d, i) {
            // First remove old word cloud:
            d3.select(".wordCloud").remove();
            // Remove its old label too:
            d3.select(".wordCloudLabel").remove();
            buildWordCloudVis(data, d);
            // Turn blue to confirm it's loaded
            d3.select(this)
              .attr("fill", "#399DB1")
              .style("font-weight", "bold");
         })
        .on("mouseout", function(d, i) {
            d3.select(this)
              .attr("fill", "#000000")
              .style("font-weight", "normal");
         })
      .append("g")
        .attr("transform", "translate(" + ((width - cellSize * 53) / 2) + "," + (height - cellSize * 7 - 1) + ")");

    svg.append("text")
        .attr("transform", "translate(-6," + cellSize * 3.5 + ")rotate(-90)")
        .style("text-anchor", "middle")
        .text(function(d) { return d; });

    var rect = svg.selectAll(".day")
        .data(function(d) { 
          return d3.time.days(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
      .enter().append("rect")
        .attr("class", "day")
        .attr("width", cellSize)
        .attr("height", cellSize)
        .attr("x", function(d) { return d3.time.weekOfYear(d) * cellSize; })
        .attr("y", function(d) { return d.getDay() * cellSize; })
        .datum(format);

    rect.append("title")
        .text(function(d) { return d; });

    svg.selectAll(".month")
        .data(function(d) { return d3.time.months(new Date(d, 0, 1), new Date(d + 1, 0, 1)); })
      .enter().append("path")
        .attr("class", "month")
        .attr("d", monthPath);

      var data = d3.nest()
        .key(function(d) {
          return d.Date; })/*
        .rollup(function(d) { 
          return d.length; })*/
        .map(data[0].values);

      rect.filter(function(d) {
        return d in data; })
          .attr("class", function(d) { return "day " + color(data[d].length); })
        .select("title")
          .text(function(d) { 
            return (data[d].length > 0) ? (d + ": " + (data[d].length) + " questions") : (d); });


    function monthPath(t0) {
      var t1 = new Date(t0.getFullYear(), t0.getMonth() + 1, 0),
          d0 = t0.getDay(), w0 = d3.time.weekOfYear(t0),
          d1 = t1.getDay(), w1 = d3.time.weekOfYear(t1);
      return "M" + (w0 + 1) * cellSize + "," + d0 * cellSize
          + "H" + w0 * cellSize + "V" + 7 * cellSize
          + "H" + w1 * cellSize + "V" + (d1 + 1) * cellSize
          + "H" + (w1 + 1) * cellSize + "V" + 0
          + "H" + (w0 + 1) * cellSize + "Z";
    }

    d3.select(self.frameElement).style("height", "2910px");


    d3.select(".calendarBox")
        .append("svg")
        .attr("class", "calendarLabel")
        .attr("width", 675)
        .attr("height", 40).append("text")
        .attr("x", 275)
        .attr("y", height - 25)
        .style("font-size","15px")
        .style("font-weight","bold")
        .attr("fill", "black")
        .text(vizLabel);

  }
    </script>
</body>
