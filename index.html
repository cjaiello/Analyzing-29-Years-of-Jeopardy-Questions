<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script src="build/d3.layout.cloud.js" charset="utf-8"></script>

<style>
/* Title of Page */
h1 {
  font-size: 20px;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
  text-align: center;
  line-height: 20px;
  color: #7f7fc5;
}
h2 {
  font-size: 17px;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
  text-align: center;
  line-height: 17px;
  color: #7f7fc5;
}
/* Body text on page */
body {
  background-color: #EBFAFF;
  font-size: 11px;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
}
/* All labels on charts */
.labels {
  font-size: 12px;
  font-weight: bold;
  font-family: Calibri,Candara,Segoe,"Segoe UI",Optima,Arial,sans-serif;
}

.td-center {
  text-align: center;
}

.td-leftpadding {
  padding-left: 50px;
}

.td-rightpadding {
  padding-right 50px;
}

.bar text.value {
  fill: #000000;
}

.axis {
  shape-rendering: crispEdges;
}

.axis path {
  fill: none;
}

.x.axis line {
  stroke: #000;
  stroke-opacity: 0.2;
}

.y.axis path {
  stroke: black;
}

</style>

<body>
  <center>
    <h1>28 Years of Jeopardy Questions!</h1>
    <h2>Choose what types of visualizations you would like to see!</h2>
    <table id="dropdowns" class="td-center">
      <tr>
        <td class="td-center td-leftpadding">
          First Visualization:
        </td>
        <td class="td-center td-rightpadding">
          <select id="firstVizDropdown">
          <option value="bar">Bar Graph</option>
          <option value="pie">Pie Chart</option>
          <option value="treemap">Tree Map</option>
        </select>
        </td>
        <td class="td-center td-leftpadding">
          Second Visualization:
        </td>
        <td class="td-center td-rightpadding">
          <select id="secondVizDropdown">
          <option value="bar">Bar Graph</option>
          <option value="pie">Pie Chart</option>
          <option value="treemap">Tree Map</option>
        </select>
        </td>
        <td class="td-center td-leftpadding">
          Third Visualization:
        </td>
        <td class="td-center td-rightpadding">
          <select id="thirdVizDropdown">
          <option value="bar">Bar Graph</option>
          <option value="pie">Pie Chart</option>
          <option value="treemap">Tree Map</option>
        </select>
        </td>
      </tr>
    </table>
  </center>
  <div id="locationOfSVGs">
  </div>
  <center>
    <table>
      <tr>
        <td>
          <div id="locationOfWordCloud" align="center">
          </div>
        </td>
      </tr>
      <tr>
        <td>
          <div id="locationOfWordCloudLabel" align="center">
          </div>
        </td>
      </tr>
    </table>
  </center>
</body> 

<script>

  d3.csv('data/jeopardy_questions_and_answers_preprocessed.csv', function(err, data) {
    if(err) console.log(err);

    // Aggregate data set
    data = aggregateByRound(data);

    buildBarVis(data, 85, 1, "Round");
  });

  /*
  * Helper for aggregating data
  * @data: The data from the csv to aggregate
  */
  function aggregateByRound(data){

    var arrayOfJeopardyQuestions = d3.nest()
    arrayOfJeopardyQuestions = d3.nest()
    .key(function(data) { 
      return data.Round; 
    })
    .entries(data);

    return arrayOfJeopardyQuestions;
  }

  /*
  * Helper for aggregating data
  * @data: The data from the csv to aggregate
  */
  function aggregateByYear(data){

    var arrayOfJeopardyQuestions = d3.nest()
    arrayOfJeopardyQuestions = d3.nest()
    .key(function(data) { 
      return data.Year; 
    })
    .entries(data);

    return arrayOfJeopardyQuestions;
  }

  /*
  * Helper for aggregating data
  * @data: The data from the csv to aggregate
  */
  function aggregateByValue(data){

    var arrayOfJeopardyQuestions = d3.nest()
    arrayOfJeopardyQuestions = d3.nest()
    .key(function(data) { 
      return data.Value; 
    })
    .entries(data);

    return arrayOfJeopardyQuestions;
  }

  // Tells the name of the viz based on its number.
  // @vizNumber: the number of the visualization,
  // which is either 1, 2, or 3
  function getVizName(vizNumber){
    vizNumber = parseInt(vizNumber);
    if(vizNumber == 1){
      return "firstChart";
    } else if(vizNumber == 2){
      return "secondChart";
    } else if(vizNumber == 3){
      return "thirdChart";
    } else return "fourthChart";
  }

  // Creates a bar visualization
  // @data: the data from the csv
  // @translateXCoordinate: How far over (x-wise) the graph should go
  // @vizNumber: The number of the viz, either 1 2 or 3
  // @vizLabel: The label for the viz (what attribute it is)
  function buildBarVis(data, translateXCoordinate, vizNumber, vizLabel) {

    var w = 365;
    var h = 600;

    var format = d3.format(",.0f");

    var x = d3.scale.linear().range([10, w-50]),
        y = d3.scale.ordinal().rangeRoundBands([0, h-50], .1);

    var xAxis = d3.svg.axis().scale(x).orient("top").ticks(4).tickSize(-h + 60),
        yAxis = d3.svg.axis().scale(y).orient("left").tickSize(0);

    var svg = d3.select("#locationOfSVGs").append("svg")
        .attr("class", getVizName(vizNumber))
        .attr("padding-left", "20")
        .attr("margin-left", "20")
        .attr("width", w+150)
        .attr("height", h)
      .append("g")
        .attr("transform", "translate(" + translateXCoordinate + "," + 30 + ")");

    // Set the scale domain.
    x.domain([0, d3.max(data, function(d) {
      return d.values.length; 
    })]);
    y.domain(data.map(function(d) { return d.key; }));

    // Adding x axis to screen
    svg.append("g")
        .attr("class", "x axis")
        .call(xAxis);

    // Adding y axis to screen
    svg.append("g")
        .attr("class", "y axis")
        .attr("transform", "translate(" + 10 + ",0)")
        .call(yAxis);

    var bar = svg.selectAll("g.bar")
        .data(data)
      .enter().append("g")
        .attr("class", "bar")
        .attr("transform", function(d) {
          return "translate(1," + y(d.key) + ")"; 
        });

    // Putting the rectangles on the bar chart
    bar.append("rect")
        .attr("fill", "#5c5cb5")
        .attr("transform", "translate(" + 10 + ",0)")
        .attr("width", function(d, i) {
          return x(d.values.length); 
        })
        .attr("height", y.rangeBand())
        .on("mouseover", function(d, i) {
          if(vizNumber == 1){
          // First, remove the old second and third charts
          d3.select("svg.secondChart")
          .remove();
          d3.select("svg.thirdChart")
            .remove();
            buildBarVis(aggregateByYear(data[i].values), 25, vizNumber + 1, "Year");
          } else if (vizNumber == 2) {
            d3.select("svg.thirdChart")
              .remove();
            buildBarVis(aggregateByValue(data[i].values), 25, vizNumber + 1, "Value");
          }
          d3.select(this)
            .attr("fill", "#a2a2d5");
         })
        .on("click", function(d, i) {
          if(vizNumber == 3){
            // First remove old word cloud:
            d3.select(".wordCloud").remove();
            // Remove its old label too:
            d3.select(".wordCloudLabel").remove();
            // Now make a new one:
            buildWordCloudVis(data[i], data[i].key);
          }})
        .on("mouseout", function() {
          d3.select(this)
            .attr("fill", "#5c5cb5");
      });

    // Placing the label text for each bar
    bar.append("text")
        .attr("class", "value")
        .attr("x", function(d) { 
          return x(d.values.length); 
        })
        .attr("y", y.rangeBand() / 2)
        .attr("dx", 20)
        .attr("dy", ".35em")
        .style("font-weight","bold")
        .attr("text-anchor", "end")
        .text(function(d) {
          return format(d.values.length); 
        });

    svg.append("text")      // text label for the x axis
        .attr("x", w / 2 - 50 )
        .attr("y", h - 30)
        .style("font-size","15px")
        .style("font-weight","bold")
        .attr("fill", "black")
        .text(vizLabel);

  }

  // This function will find matches for a specific word in a given
  // array of input.
  // @input: An array of strings
  // @ wordToFind: The word you want to find in the given input
  function findMatches(input, wordToFind){
    var numberOfMatches = 0; 
    // Go through all questions in this piece of data:
    for(var counter = 0; counter < input.length; counter++){
      var currentQuestion = input[counter];
      // And find how many matches for a particular word there are:
      var regex = new RegExp("(?:^|\\s)" + wordToFind + "(?=\\s|$)");
      var matches = currentQuestion.match(regex);
      if(matches != null){
        numberOfMatches = numberOfMatches + matches.length;
      }
    }
    return numberOfMatches;
  }

  // Function to build a wordcloud for rows in the data set
  // @data: The data from the csv
  function buildWordCloudVis(data){

    console.log(data);

    var wordMap = {}; // Key is word, value is number of times seen
    var wordMapList = []; // Just a list of all words (so, all keys)
    var questionList = []; // All questions in this data set

    // These steps populate the above three variables
    for(var counter = 0; counter < data.values.length; counter++){
      // Set 'question' equal to each item's question
      var question = data.values[counter].Question;
      questionList.push(question);
      // Split each string into an array
      var listOfWords = question.split(" ");
      // For each word in the question
      for(var innerCounter = 0; innerCounter < listOfWords.length; innerCounter++){
        var currentWord = listOfWords[innerCounter];
        // Trim away any commas and periods
        currentWord = currentWord.replace(/,$/, "");
        currentWord = currentWord.replace(/\)/, "");
        currentWord = currentWord.replace(/\(/, "");
        currentWord = currentWord.replace(/\""/, "");
        // And make it lowercase:
        currentWord = currentWord.toLowerCase();
        // If it's not an empty word or a period (or what I've deemed a plain word):
        var arrayOfPlainWords = ["\s", "\.", "a", "an", "and", "the", "was", "to", "for", "of", "is", "by", "on", "\&", "it\'s", "from", "or", "with", "at", "as", "that", "these", "be", "it", "are", "in"];
        // If this word isn't in arrayOfPlainWords:
        if(arrayOfPlainWords.indexOf(currentWord) < 0){
          // If we haven't seen this word yet
          if (!(currentWord in wordMap)){
            // Count its matches
            var numberOfMatches = findMatches(questionList, currentWord);
            // Add to our list of words seen:
            wordMapList.push(currentWord);
            // And keep track of its count as well:
            wordMap[currentWord] = numberOfMatches;
          } else {
            // Count its matches
            var numberOfMatches = findMatches(questionList, currentWord);
            // And keep track of its count as well:
            wordMap[currentWord] += numberOfMatches;
          }
        }
      }
    }

    // Colors to choose from for the words
    var color = d3.scale.linear()
            .domain([0,1,2,3,4,5,6,7, 8, 9, 10, 11, 12])
            .range(["#fa2d74", "#1e63e9", "#008547", "#785e94", "#3b0576", "#58011c", "#458b00", "#e93f1e", "#002849", "#16d79c", "#ff8d00", "#0000ff"]);


    // Actually building the word cloud
    d3.layout.cloud().size([1200, 600])
        .words(wordMapList.map(function(d) {
          return {text: d, size: 15 + wordMap[d]/2};
        }))
        .rotate(function() { return (~~(Math.random() * 6) - 3) * 30; })
        .font("Impact")
        .fontSize(function(d) { return d.size; })
        .on("end", draw)
        .start();

      
      function draw(words) {
        d3.select("#locationOfWordCloud").append("svg")
                .attr("width", 1200)
                .attr("height", 600)
                .attr("class", "wordCloud")
                .append("g")
                .attr("transform", "translate(600,300)")
                .selectAll("text")
                .data(words)
                .enter().append("text")
                .style("font-size", function(d) { return d.size + "px"; })
                .style("fill", function(d, i) { 
                  return color(Math.random() * 12); })
                .style("font-family", "\"Century Gothic\",CenturyGothic,AppleGothic,sans-serif")
                .attr("transform", function(d) {
                    return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                })
                .text(function(d) { return d.text; });
    } 
    // Lastly, label the word
    d3.select("#locationOfWordCloudLabel").append("text")
        .attr("class", "wordCloudLabel")
        .attr("x", 300)
        .attr("y", 300)
        .style("font-size","25px")
        .style("font-weight","bold")
        .attr("fill", "black")
        .text("Questions from " + data.values[0].Round + " Round in the Year " + data.values[0].Year + " With a Value of " + data.values[0].Value);
  }


  function buildPieVis(data) {
    var color = d3.scale.ordinal()
    .range(["#1c9ce9", "#679eea" , "#67d6ee", "#9becee", "#aceff1", "#9bc2ee", "#679eea" , "#69e2e5", "#1c9ce9", "#9bc2ee", "#67d6ee"]);

  // Width, height, and radius for pie chart
  var width = 1800,
  height = 800,
  radius = Math.min(width, height) / 2;

  var centerPlacement = width / 2;

  // Outer and inner radii
  var outerRadius = 200;
  var innerRadius = 0;    

  // Adding svg element to body, setting its width and height,
  // and moving it to a certain location on the screen
  var vis = d3.select("body")
  .data([data])
  .append("svg:svg") 
  .attr("width", width)
  .attr("height", height)
  .append("svg:g") 
  .attr("transform", "translate(" + 200 + "," + 300 + ")");

  // Setting inner and outer radii for each arc piece
  var arc = d3.svg.arc()
  .innerRadius(innerRadius)
  .outerRadius(outerRadius);

  // Selecting a pie chart
  var pie = d3.layout.pie()
        .value(function(d) { return d.values.length; }); // Getting length of values array

  /* Selects all slices in g, associates pie data, 
   * makes g elements for each item in the array,
   * creates groups to hold each slice,
   * and adds the class "slice" to each slice 
   * for styling purposes
   */
   var arcs = vis.selectAll("g.slice") 
   .data(pie)
   .enter()
   .append("svg:g")
   .attr("class", "slice")
   .on("mouseover", function(d, i) {
      d3.select("svg.secondVisualization")
      .remove();
      d3.select("svg.thirdVisualization")
      .remove();
        // When we mouse over a part of the donut,
        // build the inner donut chart with its data!!
        buildSecondVis(data[i].values);
      });

      // Setting slice colors and creating SVG path
      arcs.append("svg:path")
      .attr("fill", function(d, i) { 
        return color(i); } )
      .attr("d", arc);

      // Labeling each slice and placing label
      arcs.append("svg:text")
        .attr("class", "labels")
        .attr("transform", function(d) {
        // Source for the line of code below: 
        // http://bl.ocks.org/Guerino1/2295263
        return "translate(" + arc.centroid(d) + ")rotate(" + angle(d) + ")";
        })
        // Centering text on origin
        .attr("text-anchor", "middle")
        // Assigning the labels
        .text(function(d, i) { 
          return data[i].key + ": " + data[i].values.length; 
        });
      }

  // Computes the angle of an arc, converting from radians to degrees.
  // Source: http://bl.ocks.org/Guerino1/2295263
  // User Guerino1, posted on April 3, 2012
  function angle(d) {
    var a = (d.startAngle + d.endAngle) * 90 / Math.PI - 90;
    return a > 90 ? a - 180 : a;
  }

    </script>
</body>
